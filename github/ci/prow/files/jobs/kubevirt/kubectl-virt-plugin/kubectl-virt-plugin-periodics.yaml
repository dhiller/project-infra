periodics:
- name: periodic-kubectl-virt-plugin-publish
  cron: "0 0 * * *"
  decorate: true
  decoration_config:
    timeout: 1h
    grace_period: 5m
  max_concurrency: 1
  extra_refs:
  - org: kubevirt
    repo: kubectl-virt-plugin
    base_ref: master
    work_dir: true
  labels:
    preset-dind-enabled: "true"
    preset-docker-mirror: "true"
    preset-shared-images: "true"
  spec:
    containers:
      - image: quay.io/kubevirtci/kubectl-virt-builder@sha256:e9bbc789dc7fa4d9e6b326c37713f7f46a2b26cf822f1638461a0cc811e96fe0
        env:
          - name: GH_KUBECTL_VIRT_PLUGIN_USERNAME
            value: kubevirt-bot
        command:
          - "/usr/local/bin/runner.sh"
        args:
          - "/bin/sh"
          - "-c"
          - export GH_KUBECTL_VIRT_PLUGIN_TOKEN=$(</etc/github/oauth) && ./scripts/create-latest-release.sh
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "1Gi"
        volumeMounts:
          - name: token
            mountPath: /etc/github
    volumes:
      - name: token
        secret:
          secretName: oauth-token
